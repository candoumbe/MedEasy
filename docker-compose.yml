version: '3.7'

services: 
  identity.db:
    image: postgres:12-alpine  
  patients.db:
    image: postgres:12-alpine
  measures.db:
    image: postgres:12-alpine
  documents.db:
    image: postgres:12-alpine
  agenda.db:
    image: postgres:12-alpine

  identity.api:
    image: ${DOCKER_REGISTRY-}identityapi
    build:
      context: .
      dockerfile: src/services/identity/Identity.API/Dockerfile
    depends_on:
      - identity.db

  patients.api:
    image: ${DOCKER_REGISTRY-}patientsapi
    build:
      context: .
      dockerfile: src/services/patients/Patients.API/Dockerfile
    depends_on:
      - identity.api
      - patients.db

  measures.api:
    image: ${DOCKER_REGISTRY-}measuresapi
    build:
      context: .
      dockerfile: src/services/measures/Measures.API/Dockerfile
    depends_on:
      - identity.api
      - measures.db
  
  documents.api:
    image: ${DOCKER_REGISTRY-}documentsapi
    build:
      context: .
      dockerfile: src/services/document/Documents.API/Dockerfile
    depends_on:
      - identity.api
      - documents.db

  agenda.api:
    image: ${DOCKER_REGISTRY-}agendaapi
    build:
      context: .
      dockerfile: src/services/agenda/Agenda.API/Dockerfile
    depends_on:
      - identity.api
      - agenda.db

  medeasy.web:
    image: ${DOCKER_REGISTRY-}medeasyweb
    build:
      context: .
      dockerfile: src/clients/web/MedEasy.Web/Server/Dockerfile
    depends_on:
      - identity.api

   nginx:
     build:
       context: .
       dockerfile: src/clients/nginx/Dockerfile
     depends_on:
        - medeasy.web
     ports:
        - "443:443"
        - "80:80"